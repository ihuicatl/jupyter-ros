name: Check Release
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: write

jobs:
  check_release:
    runs-on: ubuntu-latest
    steps:
      - name: Install releaser
        shell: bash -eux {0}
        id: install-releaser
        run: |
          # Install Jupyter Releaser from git unless we are testing Releaser itself
          if ! command -v jupyter-releaser &> /dev/null
          then
              pip install -q git+https://github.com/jupyter-server/jupyter_releaser.git@v2
          fi
      - name: Prep release
        id: prep-release
        shell: bash -eux {0}
        run: |
          export RH_DRY_RUN="true"
          export GITHUB_ACCESS_TOKEN=${{ inputs.token }}
          export RH_VERSION_SPEC=${{ inputs.version_spec }}
          export RH_STEPS_TO_SKIP=${{ inputs.steps_to_skip }}
          python -m jupyter_releaser.actions.prep_release

      - name: Populate release
        id: populate-release
        shell: bash -eux {0}
        run: |
          export RH_DRY_RUN="true"
          export GITHUB_ACCESS_TOKEN=${{ inputs.token }}
          export RH_RELEASE_URL=${{ steps.prep-release.outputs.release_url }}
          export RH_STEPS_TO_SKIP=${{ inputs.steps_to_skip }}
          python -m jupyter_releaser.actions.populate_release

      - name: Finalize release
        id: finalize-release
        shell: bash -eux {0}
        run: |
          export RH_DRY_RUN="true"
          export GITHUB_ACCESS_TOKEN=${{ inputs.token }}
          export RH_RELEASE_URL=${{ steps.populate-release.outputs.release_url }}
          export RH_STEPS_TO_SKIP=${{ inputs.steps_to_skip }}
          python -m jupyter_releaser.actions.finalize_release
